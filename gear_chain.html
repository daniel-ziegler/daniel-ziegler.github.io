<html><head><title>Gear Puzzle</title><style type="text/css">body{margin:0;padding:0;background-color:#1a1a2e;display:flex;justify-content:center;align-items:center;min-height:100vh}canvas{background-color:#16213e;display:block;width:100vw;height:100vh}#controls{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.7);padding:15px;border-radius:8px;color:#fff;font-family:monospace;z-index:100}#controls input[type=range]{width:120px;margin-left:10px}</style></head><body><div id="controls"><label>Speed: <span id="speedVal">0.5</span> <input type="range" id="speed" min="0" max="200" value="50"></label></div><canvas id="gear_canvas"></canvas><script>var GearMath={normalizeAngle:function(e){return(e%=2*Math.PI)<0&&(e+=2*Math.PI),e},planetaryRingTeeth:function(e,t){return e+2*t},planetaryRingSpeed:function(e,t,a,r){return((a+r)*t-a*e)/r},calculateRingPhaseFromPlanet:function(e,t,a,r){var n=a/r,s=(e-Math.PI/a)*n+t*(1-n);return this.normalizeAngle(s)},calculateChildPhase:function(e,t,a,r){var n=a/r,s=Math.PI/r-Math.PI-t*(1+n)-e*n;return this.normalizeAngle(s)},calculateInternalMeshPhase:function(e,t,a,r){var n=a/r,s=t*(n-1)-Math.PI/r+e*n;return this.normalizeAngle(s)}};"undefined"!=typeof module&&module.exports&&(module.exports=GearMath);var graphics={component_to_hex:function(e){var t=Math.floor(e).toString(16);return 1==t.length?"0"+t:t},rgb_to_hex:function(e,t,a){return"#"+this.component_to_hex(e)+this.component_to_hex(t)+this.component_to_hex(a)},init:function(e,t){return{canvas:e,context:e.getContext("2d"),width:e.width,height:e.height,bounds:t,colour:this.rgb_to_hex(0,0,0)}},clear:function(e){e.context.fillStyle="#16213e",e.context.fillRect(0,0,e.canvas.width,e.canvas.height)},color:function(e,t,a,r){e.colour=this.rgb_to_hex(t,a,r)},map_point:function(e,t){var a=e.width/(e.bounds[1]-e.bounds[0]),r=e.height/(e.bounds[3]-e.bounds[2]),n=Math.min(a,r),s=e.bounds[1]-e.bounds[0],i=e.bounds[3]-e.bounds[2],o=(e.width-s*n)/2,h=(e.height-i*n)/2;return[o+(t[0]-e.bounds[0])*n,h+(t[1]-e.bounds[2])*n]},circle:function(e,t,a){var r=this.map_point(e,t),n=this.map_point(e,[t[0]+a,t[1]])[0]-r[0];e.context.beginPath(),e.context.arc(r[0],r[1],n,0,2*Math.PI),e.context.strokeStyle=e.colour,e.context.stroke()},fillCircle:function(e,t,a){var r=this.map_point(e,t),n=this.map_point(e,[t[0]+a,t[1]])[0]-r[0];e.context.beginPath(),e.context.arc(r[0],r[1],n,0,2*Math.PI),e.context.fillStyle=e.colour,e.context.fill()},text:function(e,t,a,r){var n=this.map_point(e,t),s=1.5*(this.map_point(e,[t[0]+r,t[1]])[0]-n[0]);e.context.font="bold "+s+"px Arial",e.context.fillStyle=e.colour,e.context.textAlign="center",e.context.textBaseline="middle",e.context.fillText(a,n[0],n[1])},textRotated:function(e,t,a,r,n){var s=this.map_point(e,t),i=1.5*(this.map_point(e,[t[0]+r,t[1]])[0]-s[0]),o=e.context;o.save(),o.translate(s[0],s[1]),o.rotate(-n),o.font="bold "+i+"px Arial",o.fillStyle=e.colour,o.textAlign="center",o.textBaseline="middle",o.fillText(a,0,0),o.restore()},polyline:function(e,t,a){e.context.fillStyle=e.colour,e.context.strokeStyle="#0f0f23",e.context.lineWidth=1,e.context.beginPath();var r=this.map_point(e,t[0]);e.context.moveTo(r[0],r[1]);for(var n=1;n<t.length;n++)r=this.map_point(e,t[n]),e.context.lineTo(r[0],r[1]);e.context.closePath(),e.context.fill(),e.context.stroke()},arcArrowCW:function(e,t,a,r,n,s){var i=this.map_point(e,t),o=this.map_point(e,[t[0]+a,t[1]])[0]-i[0],h=e.context,p=this.map_point(e,[s,0]),l=this.map_point(e,[0,0]),u=Math.max(2,p[0]-l[0]),c=2.5*u,m=n+c/o*.8;h.beginPath(),h.strokeStyle=e.colour,h.lineWidth=u,h.lineCap="round",h.arc(i[0],i[1],o,-r,-m,!1),h.stroke();var f=i[0]+o*Math.cos(-n),d=i[1]+o*Math.sin(-n),g=n-Math.PI/2;h.beginPath(),h.fillStyle=e.colour;var M=g+Math.PI+Math.PI/6,v=g+Math.PI-Math.PI/6;h.moveTo(f,d),h.lineTo(f+c*Math.cos(-M),d+c*Math.sin(-M)),h.lineTo(f+c*Math.cos(-v),d+c*Math.sin(-v)),h.closePath(),h.fill()}},gears={point_radius:function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},rotate_point:function(e,t,a){var r=[t[0]-e[0],t[1]-e[1]],n=Math.cos(a),s=Math.sin(a);return[n*r[0]+s*r[1]+e[0],-s*r[0]+n*r[1]+e[1]]},involute_point:function(e,t){return[e*(Math.cos(t)+t*Math.sin(t)),-e*(Math.sin(t)-t*Math.cos(t))]},involute_bisect:function(e,t){for(var a=0,r=Math.PI,n=0;n<20;n++){var s=(a+r)/2;this.point_radius(this.involute_point(e,s))<=t?a=s:r=s}return(a+r)/2},involute_curve:function(e,t,a,r){var n=this.involute_bisect(e,a),s=[];t<e&&s.push([t,0]);for(var i=n/(r-1),o=0;o<r;o++)s.push(this.involute_point(e,o*i));return s},generate:function(e,t,a){for(var r=e*a/2,n=r*Math.cos(t),s=r-1.2*e,i=r+1*e,o=Math.PI*r/a,h=this.involute_point(n,this.involute_bisect(n,r)),p=Math.atan2(h[1],h[0]),l=o/r,u=this.involute_curve(n,s,i,20),c=[],m=0;m<u.length;m++){var f=this.rotate_point([0,0],u[m],p-l/2);Math.atan2(f[1],f[0])<Math.PI/a&&f[1]>0&&c.push([u[m][0],u[m][1]])}var d=[];for(m=0;m<a;m++){for(var g=2*m*Math.PI/a+p-l/2,M=2*m*Math.PI/a-p+l/2,v=0;v<c.length;v++)d.push(this.rotate_point([0,0],c[v],g));for(v=c.length-1;v>=0;v--)d.push(this.rotate_point([0,0],[c[v][0],-c[v][1]],M))}return d},translate:function(e,t){return e.map(function(e){return[e[0]+t[0],e[1]+t[1]]})},rotate:function(e,t){var a=Math.cos(t),r=Math.sin(t);return e.map(function(e){return[a*e[0]+r*e[1],-r*e[0]+a*e[1]]})},generateCarrier:function(e,t,a,r,n,s){return{innerRingOuter:a+.5*e,innerRingInner:a-.5*e,outerGear:this.generate(e,t,r),outerRimInner:e*r/2-1.2*e-1*e,spokeCount:n,spokeWidth:s}},generateInternal:function(e,t,a,r,n){n=n||1;for(var s=this,i=this.generate(e,t,a),o=0,h=1/0,p=0;p<i.length;p++)(M=this.point_radius(i[p]))>o&&(o=M),M<h&&(h=M);var l=o-h,u=l*n,c=e*a/2+1*e,m=i.map(function(e){var t=s.point_radius(e),a=Math.atan2(e[1],e[0]),r=o+h-(h+(t-h)/l*u)+(c-o);return[r*Math.cos(a),r*Math.sin(a)]}),f=0;for(p=0;p<m.length;p++)(M=this.point_radius(m[p]))>f&&(f=M);var d=null,g=f+2*e;if(r)for(d=this.generate(e,t,r).map(function(e){var t=s.point_radius(e),a=Math.atan2(e[1],e[0]);return[t*Math.cos(a),t*Math.sin(a)]}),g=0,p=0;p<d.length;p++){var M;(M=this.point_radius(d[p]))>g&&(g=M)}return{profile:m,outerProfile:d,outerRadius:g,innerOuterR:f}}},GearSystem={module:1,pa:20*Math.PI/180,meshDist:function(e,t){return this.module*(e+t)/2},posAt:function(e,t,a){return[e[0]+a*Math.cos(t),e[1]-a*Math.sin(t)]},createPlanetaryGearset:function(e){for(var t=e||{},a=t.prefix||"",r=t.center||[0,0],n=t.sunTeeth||12,s=t.planetTeeth||6,i=t.numPlanets||3,o=t.carrierOuterTeeth||42,h=t.ringOuterTeeth||33,p=t.colors||{},l=GearMath.planetaryRingTeeth(n,s),u=this.meshDist(n,s),c=n/s,m=[],f=a||"planetary",d=[],g=0;g<i;g++)d.push(a+"planet"+g);for(m.push({id:a+"carrier",pos:r,gears:[o],colors:[p.carrier||[180,130,70]],meshParent:null,speedMult:0,meshDir:1,phaseOffset:0,isCarrier:!0,carrierConfig:{innerRadius:u,spokeCount:i,spokeWidth:1},zPriority:3,planetaryId:a,planetaryConstraint:{type:"carrier",setId:f}}),m.push({id:a+"ring",pos:r,gears:[l],outerTeeth:h,colors:[p.ring||[120,90,200]],meshParent:null,speedMult:0,meshDir:1,phaseOffset:0,isInternal:!0,zPriority:-1,planetaryId:a,planetaryConstraint:{type:"ring",setId:f}}),m.push({id:a+"sun",pos:r,gears:[n],colors:[p.sun||[255,200,80]],meshParent:null,speedMult:1,meshDir:1,phaseOffset:0,planetaryId:a,planetaryConstraint:{type:"sun",setId:f}}),g=0;g<i;g++){var M=2*g*Math.PI/i;m.push({id:a+"planet"+g,pos:this.posAt(r,M,u),gears:[s],colors:[p.planet||[100,180,255]],meshParent:a+"sun",meshGearIdx:0,parentGearIdx:0,speedMult:c,meshDir:-1,orbits:a+"sun",orbitSpeed:0,orbitRadius:u,orbitPhase:M,planetaryId:a,planetaryConstraint:{type:"planet",setId:f}})}return{axles:m,config:{id:f,prefix:a,sunTeeth:n,planetTeeth:s,ringTeeth:l,numPlanets:i,gearRatio:c,carrierOuterTeeth:o,ringOuterTeeth:h,orbitRadius:u,center:r,sunId:a+"sun",carrierId:a+"carrier",ringId:a+"ring",planetIds:d}}},updateOrbitingGears:function(e,t){for(var a in e){var r=e[a];if(r.orbits){var n=e[r.orbits],s=null;void 0!==r.planetaryId&&(s=e[r.planetaryId+"carrier"]);var i=s?t*s.speedMult*s.meshDir:t*(r.orbitSpeed||0),o=s&&s.phaseOffset||0,h=i+(r.orbitPhase||0)+o;r.pos=[n.pos[0]+r.orbitRadius*Math.cos(h),n.pos[1]-r.orbitRadius*Math.sin(h)];var p=-h,l=n.gears[r.parentGearIdx||0],u=r.gears[r.meshGearIdx||0];r.phaseOffset=GearMath.calculateChildPhase(n.phaseOffset||0,p,l,u)}}},generateShapes:function(e){var t={},a={},r=this;e.forEach(function(e){if(e.isCarrier){var n=e.carrierConfig;e.carrierShape=gears.generateCarrier(r.module,r.pa,n.innerRadius,e.gears[0],n.spokeCount,n.spokeWidth)}else if(e.isInternal){var s=e.outerTeeth||null,i=e.gears[0]+"_"+(s||"none");a[i]||(a[i]=gears.generateInternal(r.module,r.pa,e.gears[0],s)),e.gearShapes=[a[i]]}else e.gearShapes=e.gears.map(function(e){return t[e]||(t[e]=gears.generate(r.module,r.pa,e)),t[e]})})}},puzzle={module:1,pa:20*Math.PI/180,baseSpeed:.5,axles:[],planetarySets:[],outputGears:[]},adjustParams={driverAngle:.08,driverRadius:45,yellowAngleOffset:-44,yellowSpacerBend:-6,orangeAngleOffset:-37,redAngleOffset:-4,blueAngleOffset:-40,blueBend:84,sunInputAngle:6,sunBendAngle:54,greenInter1Angle:0,greenOutputAngle:-49,speed:.5};function setupPuzzle(){GearSystem.module=puzzle.module,GearSystem.pa=puzzle.pa;var e=[],t=Math.PI/2,a=Math.PI/10,r=17*Math.PI/10,n=13*Math.PI/10,s=9*Math.PI/10,i=Math.PI*adjustParams.driverAngle,o=adjustParams.driverRadius,h=GearSystem.posAt([0,0],i,o),p=GearSystem.meshDist(6,36),l=GearSystem.posAt(h,i,p),u=GearSystem.meshDist(36,12),c=GearSystem.meshDist(12,21),m=GearSystem.meshDist(42,12),f=adjustParams.sunInputAngle*Math.PI/180,d=Math.atan2(-h[1],-h[0])+f,g=GearSystem.posAt(h,d,u),M=GearSystem.posAt(g,d,c),v=d+adjustParams.sunBendAngle*Math.PI/180,x=GearSystem.posAt(M,v,m),P=GearSystem.createPlanetaryGearset({prefix:"",center:x,sunTeeth:12,planetTeeth:6,numPlanets:3,carrierOuterTeeth:36,ringOuterTeeth:42});e=e.concat(P.axles),puzzle.planetarySets.push(P.config),puzzle.planetary=P.config;var I=x;e.push({id:"driver",pos:l,gears:[6],colors:[[255,100,100]],meshParent:null,speedMult:1,meshDir:1,phaseOffset:0,isDriver:!0}),e.push({id:"hub",pos:h,gears:[36],colors:[[200,180,160]],meshParent:"driver",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0}),e.push({id:"sunIdler",pos:g,gears:[12],colors:[[255,180,60]],meshParent:"hub",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0}),e.push({id:"sunInput1",pos:M,gears:[21,42],colors:[[255,200,100],[230,180,80]],meshParent:"sunIdler",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:-1});var y=e.find(function(e){return"sun"===e.id});y.meshParent="sunInput1",y.meshGearIdx=0,y.parentGearIdx=1,y.meshDir=-1;var _=t+adjustParams.redAngleOffset*Math.PI/180,G=GearSystem.meshDist(36,30),z=GearSystem.posAt(h,_,G),S=GearSystem.meshDist(6,24),b=GearSystem.posAt(z,_,S);e.push({id:"red_inter1",pos:z,gears:[30,6],colors:[[220,60,60],[180,40,40]],meshParent:"hub",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:1}),e.push({id:"red_output",pos:b,gears:[24],colors:[[255,80,80]],meshParent:"red_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:20,zPriority:2});var O=r+adjustParams.yellowAngleOffset*Math.PI/180,D=GearSystem.meshDist(36,36),A=GearSystem.posAt(h,O,D),T=O+adjustParams.yellowSpacerBend*Math.PI/180,C=GearSystem.meshDist(6,24),R=GearSystem.posAt(A,T,C),w=GearSystem.meshDist(24,18),k=GearSystem.posAt(R,T,w);e.push({id:"yellow_inter1",pos:A,gears:[36,6],colors:[[220,200,60],[180,160,40]],meshParent:"hub",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:2}),e.push({id:"yellow_spacer",pos:R,gears:[24],colors:[[200,180,50]],meshParent:"yellow_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,zPriority:2}),e.push({id:"yellow_output",pos:k,gears:[18],colors:[[255,220,60]],meshParent:"yellow_spacer",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:18,zPriority:3});var W,E,j,B,F,L,q,H,V,J,K,N,Q,U,X,Y=(W=A,j=GearSystem.meshDist(36,14),B=GearSystem.meshDist(36,36),F=(E=I)[0]-W[0],L=E[1]-W[1],H=(j*j-B*B+(q=Math.sqrt(F*F+L*L))*q)/(2*q),V=Math.sqrt(Math.max(0,j*j-H*H)),(U=[(J=W[0]+H*F/q)+V*(N=-L/q),(K=W[1]+H*L/q)+V*(Q=F/q)])[1]>(X=[J-V*N,K-V*Q])[1]?U:X);e.push({id:"carrierInput1",pos:Y,gears:[14,36],colors:[[180,150,100],[160,130,80]],meshParent:"yellow_inter1",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:1});var Z=e.find(function(e){return"carrier"===e.id});Z.meshParent="carrierInput1",Z.meshGearIdx=0,Z.parentGearIdx=1,Z.meshDir=-1;var $=s+adjustParams.blueAngleOffset*Math.PI/180,ee=GearSystem.meshDist(42,36),te=GearSystem.posAt(M,$,ee),ae=$+adjustParams.blueBend*Math.PI/180,re=GearSystem.meshDist(6,38),ne=GearSystem.posAt(te,ae,re);e.push({id:"blue_inter1",pos:te,gears:[36,6],colors:[[60,100,200],[40,80,180]],meshParent:"sunInput1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,zPriority:1}),e.push({id:"blue_output",pos:ne,gears:[38],colors:[[80,140,255]],meshParent:"blue_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:19,zPriority:2});var se=n+adjustParams.greenInter1Angle*Math.PI/180,ie=se+adjustParams.greenOutputAngle*Math.PI/180,oe=GearSystem.meshDist(42,21),he=GearSystem.posAt(I,se,oe),pe=GearSystem.meshDist(6,24),le=GearSystem.posAt(he,ie,pe);e.push({id:"green_inter1",pos:he,gears:[21,6],colors:[[60,180,80],[40,160,60]],meshParent:"ring",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,meshWithOuter:!0,zPriority:1}),e.push({id:"green_output",pos:le,gears:[24],colors:[[80,220,100]],meshParent:"green_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:14,zPriority:2});var ue=24*GearSystem.module/2,ce=60+25*GearSystem.module,me=Math.round(2*ce/GearSystem.module);me%2!=0&&me++;var fe=(ce=GearSystem.module*me/2)-ue,de=Math.sqrt(le[0]*le[0]+le[1]*le[1]),ge=-le[0]/de,Me=-le[1]/de,ve=[le[0]+fe*ge,le[1]+fe*Me];e.push({id:"outerRing",pos:ve,gears:[me],colors:[[80,80,120]],meshParent:"green_output",meshGearIdx:0,parentGearIdx:0,meshDir:1,phaseOffset:0,isInternal:!0,isOuterRing:!0,zPriority:-5}),puzzle.outerRingTeeth=me;var xe=a+adjustParams.orangeAngleOffset*Math.PI/180,Pe=ce-36*GearSystem.module/2,Ie=GearSystem.posAt(ve,xe,Pe);e.push({id:"orange_output",pos:Ie,gears:[36],colors:[[255,140,40]],meshParent:"outerRing",meshGearIdx:0,parentGearIdx:0,meshDir:1,phaseOffset:0,meshWithInternal:!0,isLeaf:!0,ratio:21,zPriority:2}),puzzle.outputGears=["red_output","orange_output","yellow_output","green_output","blue_output"],puzzle.axles=e,calculateSpeeds(),calculatePhaseOffsets(),GearSystem.generateShapes(puzzle.axles)}function getParents(e){if(e.planetaryConstraint){var t=e.planetaryConstraint.type;if("ring"===t||"planet"===t)return[]}return e.meshParent?[e.meshParent]:[]}function isInternalMesh(e,t){return e.isInternal&&!t.meshWithOuter||t.meshWithInternal||t.isInternal}function getEffectiveTeeth(e,t){return t.meshWithOuter&&e.outerTeeth?e.outerTeeth:e.gears[t.parentGearIdx||0]}function checkPlanetaryConstraint(e,t,a,r,n,s){if(e.planetaryConstraint){var i=e.planetaryConstraint.setId,o=puzzle.planetarySets.find(function(e){return e.id===i});if(o){var h=t[o.sunId],p=t[o.carrierId];if(a[o.sunId]&&a[o.carrierId]&&!a[o.ringId]){var l=t[o.ringId],u=o.sunTeeth,c=o.ringTeeth,m=o.planetTeeth;if("speed"===s){var f=h.speedMult*h.meshDir,d=p.speedMult*p.meshDir,g=GearMath.planetaryRingSpeed(f,d,u,c);l.speedMult=Math.abs(g),l.meshDir=g>=0?1:-1}else if("phase"===s){var M=p.phaseOffset||0,v=-M,x=GearMath.calculateChildPhase(h.phaseOffset||0,v,u,m),P=M;l.phaseOffset=GearMath.calculateRingPhaseFromPlanet(x,P,m,c)}r.push(l.id),o.planetIds.forEach(function(e){if(!a[e]){var n=t[e];"speed"===s&&(n.speedMult=h.speedMult*(u/m),n.meshDir=-h.meshDir,n.orbitSpeed=p.speedMult,n.orbitDir=p.meshDir),a[e]=!0,r.push(e)}})}}}}function bfsTraverse(e,t,a){var r={};e.forEach(function(e){r[e.id]=e});var n={},s={},i=[];for(e.forEach(function(e){var t=getParents(e);if(s[e.id]=t.length,e.planetaryConstraint){var a=e.planetaryConstraint.type;if("ring"===a||"planet"===a)return}0===t.length&&i.push(e.id)});i.length>0;){var o=i.shift();if(!n[o]){var h=r[o];t(h,r,n),n[o]=!0,e.forEach(function(e){getParents(e).includes(o)&&(s[e.id]--,0!==s[e.id]||n[e.id]||i.push(e.id))}),checkPlanetaryConstraint(h,r,n,i,t,a)}}return r}function calculateSpeeds(){var e=bfsTraverse(puzzle.axles,function(e,t,a){if(e.isDriver)return e.speedMult=1,void(e.meshDir=1);if(e.planetaryConstraint){var r=e.planetaryConstraint.type;if("ring"===r||"planet"===r)return}if(e.meshParent){var n=t[e.meshParent];if(n){var s=getEffectiveTeeth(n,e),i=e.gears[e.meshGearIdx||0];e.speedMult=n.speedMult*(s/i),e.meshDir=isInternalMesh(n,e)?n.meshDir:-n.meshDir}}},"speed");puzzle.axleMap=e}function calculatePhaseOffsets(){bfsTraverse(puzzle.axles,function(e,t,a){if(e.isDriver)e.phaseOffset=0;else{if(e.planetaryConstraint){var r=e.planetaryConstraint.type;if("ring"===r)return;if("planet"===r)return}if(e.meshParent){var n=t[e.meshParent];if(n){var s=getEffectiveTeeth(n,e),i=e.gears[e.meshGearIdx||0],o=e.pos[0]-n.pos[0],h=e.pos[1]-n.pos[1],p=Math.atan2(h,o);isInternalMesh(n,e)?e.phaseOffset=GearMath.calculateInternalMeshPhase(n.phaseOffset||0,p,s,i):e.phaseOffset=GearMath.calculateChildPhase(n.phaseOffset||0,p,s,i)}}}},"phase")}var anim={ctx:null,baseAngle:0,lastTime:0};function resizeCanvas(){var e=document.getElementById("gear_canvas");e.width=window.innerWidth,e.height=window.innerHeight;var t=1/0,a=-1/0,r=1/0,n=-1/0;puzzle.axles.forEach(function(e){var s=Math.max.apply(null,e.gears)*puzzle.module/2+1.5*puzzle.module;t=Math.min(t,e.pos[0]-s),a=Math.max(a,e.pos[0]+s),r=Math.min(r,e.pos[1]-s),n=Math.max(n,e.pos[1]+s)}),anim.ctx=graphics.init(e,[t-5,a+5,r-5,n+5])}function init(){setupPuzzle(),resizeCanvas(),window.addEventListener("resize",resizeCanvas),document.getElementById("speed").addEventListener("input",function(){adjustParams.speed=parseInt(this.value)/100,document.getElementById("speedVal").textContent=adjustParams.speed.toFixed(2)}),anim.lastTime=performance.now(),requestAnimationFrame(drawFrame)}function drawFrame(e){var t=(e-anim.lastTime)/1e3;anim.lastTime=e,anim.baseAngle-=adjustParams.speed*t;var a=puzzle.axleMap;a||(a={},puzzle.axles.forEach(function(e){a[e.id]=e}),puzzle.axleMap=a),GearSystem.updateOrbitingGears(a,anim.baseAngle),graphics.clear(anim.ctx),puzzle.axles.slice().sort(function(e,t){var a=e.zPriority||0,r=t.zPriority||0;return a!==r?a-r:Math.max.apply(null,t.gears)-Math.max.apply(null,e.gears)}).forEach(function(e){var t=anim.baseAngle*e.speedMult*e.meshDir+(e.phaseOffset||0);if(e.isCarrier){var a=e.carrierShape,r=e.colors[0],n=anim.ctx.context,s=graphics.map_point(anim.ctx,e.pos),i=.15,o=graphics.map_point(anim.ctx,[i,0])[0]-graphics.map_point(anim.ctx,[0,0])[0];o=Math.max(1,o);var h=t,p=a.spokeWidth/2,l=a.spokeCount;Math.atan2(p,a.outerRimInner),n.beginPath();var u=gears.rotate(a.outerGear,t),c=(u=gears.translate(u,e.pos)).map(function(e){return graphics.map_point(anim.ctx,e)});n.moveTo(c[0][0],c[0][1]);for(var m=1;m<c.length;m++)n.lineTo(c[m][0],c[m][1]);n.closePath();for(var f=a.outerRimInner,d=a.innerRingOuter,g=graphics.map_point(anim.ctx,[e.pos[0]+f,e.pos[1]])[0]-s[0],M=graphics.map_point(anim.ctx,[e.pos[0]+d,e.pos[1]])[0]-s[0],v=graphics.map_point(anim.ctx,[p,0])[0]-graphics.map_point(anim.ctx,[0,0])[0],x=0;x<l;x++){var P=-(h+2*x*Math.PI/l),I=-(h+2*(x+1)*Math.PI/l),y=-Math.sin(P),_=Math.cos(P),G=-Math.sin(I),z=Math.cos(I),S=Math.atan2(g*Math.sin(P)-v*_,g*Math.cos(P)-v*y),b=Math.atan2(g*Math.sin(I)+v*z,g*Math.cos(I)+v*G),O=Math.atan2(M*Math.sin(I)+v*z,M*Math.cos(I)+v*G),D=Math.atan2(M*Math.sin(I)-v*z,M*Math.cos(I)-v*G);if(0===x){var A=s[0]+g*Math.cos(S),T=s[1]+g*Math.sin(S);n.moveTo(A,T)}n.arc(s[0],s[1],g,S,b,!0);var C=s[0]+M*Math.cos(O),R=s[1]+M*Math.sin(O);n.lineTo(C,R),n.arc(s[0],s[1],M,O,D,!0);var w=Math.atan2(g*Math.sin(I)-v*z,g*Math.cos(I)-v*G),k=s[0]+g*Math.cos(w),W=s[1]+g*Math.sin(w);n.lineTo(k,W)}n.closePath(),n.fillStyle=graphics.rgb_to_hex(r[0],r[1],r[2]),n.fill("evenodd"),n.strokeStyle="#0f0f23",n.lineWidth=o,n.stroke(),n.beginPath();var E=graphics.map_point(anim.ctx,[e.pos[0]+a.innerRingInner,e.pos[1]])[0]-s[0];n.arc(s[0],s[1],M,0,2*Math.PI,!1),n.moveTo(s[0]+E,s[1]),n.arc(s[0],s[1],E,0,2*Math.PI,!0),n.fillStyle=graphics.rgb_to_hex(r[0],r[1],r[2]),n.fill("evenodd"),n.strokeStyle="#0f0f23",n.lineWidth=o,n.stroke();var j=puzzle.planetary.orbitRadius,B=1.3*puzzle.module;for(x=0;x<l;x++){var F=h+2*x*Math.PI/l,L=e.pos[0]+j*Math.cos(F),q=e.pos[1]-j*Math.sin(F),H=graphics.map_point(anim.ctx,[L,q]),V=graphics.map_point(anim.ctx,[0+B,0])[0]-graphics.map_point(anim.ctx,[0,0])[0],J=graphics.map_point(anim.ctx,[.5,0])[0]-graphics.map_point(anim.ctx,[0,0])[0];n.beginPath(),n.arc(H[0],H[1],V,0,2*Math.PI,!1),n.moveTo(H[0]+J,H[1]),n.arc(H[0],H[1],J,0,2*Math.PI,!0),n.fillStyle=graphics.rgb_to_hex(r[0],r[1],r[2]),n.fill("evenodd"),n.beginPath(),n.arc(H[0],H[1],J,0,2*Math.PI,!1),n.strokeStyle="#0f0f23",n.lineWidth=o,n.stroke(),Math.PI;var K=Math.atan2(s[1]-H[1],s[0]-H[0]),N=K+Math.PI,Q=V,U=Math.sqrt(Math.pow(H[0]-s[0],2)+Math.pow(H[1]-s[1],2));function X(e){if(U>0&&U<Q+e&&U>Math.abs(Q-e)){var t=(U*U+Q*Q-e*e)/(2*U*Q);t=Math.max(-1,Math.min(1,t));var a=Math.acos(t);return{right:K-a,left:K+a}}return null}var Y=X(graphics.map_point(anim.ctx,[e.pos[0]+a.innerRingInner,e.pos[1]])[0]-s[0]),Z=X(M),$=Math.asin(Math.min(1,v/Q)),ee=N-$,te=N+$;n.lineWidth=o,n.strokeStyle="#0f0f23",Y&&(n.beginPath(),n.arc(H[0],H[1],V,Y.right,Y.left,!1),n.stroke()),Z&&(n.beginPath(),n.arc(H[0],H[1],V,te,Z.right,!1),n.stroke(),n.beginPath(),n.arc(H[0],H[1],V,Z.left,ee,!1),n.stroke())}}else if(e.isInternal)for(var ae=0;ae<e.gears.length;ae++){var re=e.gearShapes[ae],ne=gears.rotate(re.profile,t);ne=gears.translate(ne,e.pos),r=e.colors[ae],n=anim.ctx.context,s=graphics.map_point(anim.ctx,e.pos),i=.15;var se=graphics.map_point(anim.ctx,[i,0])[0]-graphics.map_point(anim.ctx,[0,0])[0];if(se=Math.max(1,se),n.beginPath(),re.outerProfile){var ie=gears.rotate(re.outerProfile,t);for(c=(ie=gears.translate(ie,e.pos)).map(function(e){return graphics.map_point(anim.ctx,e)}),n.moveTo(c[0][0],c[0][1]),m=1;m<c.length;m++)n.lineTo(c[m][0],c[m][1]);n.closePath()}else{var oe=re.outerRadius,he=graphics.map_point(anim.ctx,[e.pos[0]+oe,e.pos[1]])[0]-s[0];n.arc(s[0],s[1],he,0,2*Math.PI,!1)}var pe=ne.map(function(e){return graphics.map_point(anim.ctx,e)});for(n.moveTo(pe[0][0],pe[0][1]),m=pe.length-1;m>=0;m--)n.lineTo(pe[m][0],pe[m][1]);n.closePath(),n.fillStyle=graphics.rgb_to_hex(r[0],r[1],r[2]),n.fill("evenodd"),n.strokeStyle="#0f0f23",n.lineWidth=se,n.stroke()}else{var le=[];for(x=0;x<e.gears.length;x++)le.push(x);le.sort(function(t,a){return e.gears[a]-e.gears[t]});for(var ue=0;ue<le.length;ue++){ae=le[ue];var ce=gears.rotate(e.gearShapes[ae],t);ce=gears.translate(ce,e.pos),r=e.colors[ae],graphics.color(anim.ctx,r[0],r[1],r[2]),graphics.polyline(anim.ctx,ce,!0);var me=e.gears[ae];if(me>12){var fe=puzzle.module*me/2,de=.65*fe,ge=e.pos[0]+de*Math.cos(t),Me=e.pos[1]-de*Math.sin(t);graphics.color(anim.ctx,255,255,255),graphics.textRotated(anim.ctx,[ge,Me],me.toString(),.2*fe,t-Math.PI/2)}}}}),puzzle.axles.forEach(function(e){e.isOuterRing||(graphics.color(anim.ctx,30,30,50),graphics.fillCircle(anim.ctx,e.pos,.8))}),puzzle.axles.forEach(function(e){var t=null,a=0;if(e.isDriver?(t="1",a=2):e.isLeaf&&(t="?",a=4),t){var r=e.pos[0],n=e.pos[1],s=anim.baseAngle*e.speedMult*e.meshDir+(e.phaseOffset||0);graphics.color(anim.ctx,255,255,255),graphics.fillCircle(anim.ctx,[r,n],a),graphics.color(anim.ctx,30,30,50),graphics.textRotated(anim.ctx,[r,n],t,1.2*a,s)}});var r=a.outerRing;if(r){var n=puzzle.module*puzzle.outerRingTeeth/2+8,s=Math.PI/4+.25,i=Math.PI/4-.15;graphics.color(anim.ctx,200,200,200),graphics.arcArrowCW(anim.ctx,r.pos,n,s,i,.8)}requestAnimationFrame(drawFrame)}window.onload=init;</script></body></html>