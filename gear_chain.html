<html><head><meta name="viewport" content="width=device-width,initial-scale=1"><title>Gear Puzzle</title><style type="text/css">body{margin:0;padding:0;background-color:#1a1a2e;display:flex;justify-content:center;align-items:center;min-height:100vh}canvas{background-color:#16213e;display:block}#controls{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.7);padding:15px;border-radius:8px;color:#fff;font-family:monospace;z-index:100}#controls input[type=range]{width:120px;margin-left:10px}</style></head><body><div id="controls"><label>Speed: <span id="speedVal">0.5</span> <input type="range" id="speed" min="0" max="200" value="50"></label></div><canvas id="gear_canvas"></canvas><script>var GearMath={normalizeAngle:function(e){return(e%=2*Math.PI)<0&&(e+=2*Math.PI),e},planetaryRingTeeth:function(e,t){return e+2*t},planetaryRingSpeed:function(e,t,r,a){return((r+a)*t-r*e)/a},calculateRingPhaseFromPlanet:function(e,t,r,a){var n=r/a,s=(e-Math.PI/r)*n+t*(1-n);return this.normalizeAngle(s)},calculateChildPhase:function(e,t,r,a){var n=r/a,s=Math.PI/a-Math.PI-t*(1+n)-e*n;return this.normalizeAngle(s)},calculateInternalMeshPhase:function(e,t,r,a){var n=r/a,s=t*(n-1)-Math.PI/a+e*n;return this.normalizeAngle(s)}};"undefined"!=typeof module&&module.exports&&(module.exports=GearMath);var graphics={component_to_hex:function(e){var t=Math.floor(e).toString(16);return 1==t.length?"0"+t:t},rgb_to_hex:function(e,t,r){return"#"+this.component_to_hex(e)+this.component_to_hex(t)+this.component_to_hex(r)},init:function(e,t){return{canvas:e,context:e.getContext("2d"),width:e.width,height:e.height,bounds:t,colour:this.rgb_to_hex(0,0,0)}},clear:function(e){e.context.fillStyle="#16213e",e.context.fillRect(0,0,e.canvas.width,e.canvas.height)},color:function(e,t,r,a){e.colour=this.rgb_to_hex(t,r,a)},map_point:function(e,t){var r=e.width/(e.bounds[1]-e.bounds[0]),a=e.height/(e.bounds[3]-e.bounds[2]),n=Math.min(r,a),s=e.bounds[1]-e.bounds[0],i=e.bounds[3]-e.bounds[2],o=(e.width-s*n)/2,h=(e.height-i*n)/2;return[o+(t[0]-e.bounds[0])*n,h+(t[1]-e.bounds[2])*n]},circle:function(e,t,r){var a=this.map_point(e,t),n=this.map_point(e,[t[0]+r,t[1]])[0]-a[0];e.context.beginPath(),e.context.arc(a[0],a[1],n,0,2*Math.PI),e.context.strokeStyle=e.colour,e.context.stroke()},fillCircle:function(e,t,r){var a=this.map_point(e,t),n=this.map_point(e,[t[0]+r,t[1]])[0]-a[0];e.context.beginPath(),e.context.arc(a[0],a[1],n,0,2*Math.PI),e.context.fillStyle=e.colour,e.context.fill()},text:function(e,t,r,a){var n=this.map_point(e,t),s=1.5*(this.map_point(e,[t[0]+a,t[1]])[0]-n[0]);e.context.font="bold "+s+"px Arial",e.context.fillStyle=e.colour,e.context.textAlign="center",e.context.textBaseline="middle",e.context.fillText(r,n[0],n[1])},textRotated:function(e,t,r,a,n){var s=this.map_point(e,t),i=1.5*(this.map_point(e,[t[0]+a,t[1]])[0]-s[0]),o=e.context;o.save(),o.translate(s[0],s[1]),o.rotate(-n),o.font="bold "+i+"px Arial",o.fillStyle=e.colour,o.textAlign="center",o.textBaseline="middle",o.fillText(r,0,0),o.restore()},polyline:function(e,t,r){e.context.fillStyle=e.colour,e.context.strokeStyle="#0f0f23",e.context.lineWidth=1,e.context.beginPath();var a=this.map_point(e,t[0]);e.context.moveTo(a[0],a[1]);for(var n=1;n<t.length;n++)a=this.map_point(e,t[n]),e.context.lineTo(a[0],a[1]);e.context.closePath(),e.context.fill(),e.context.stroke()},arcArrowCW:function(e,t,r,a,n,s){var i=this.map_point(e,t),o=this.map_point(e,[t[0]+r,t[1]])[0]-i[0],h=e.context,l=this.map_point(e,[s,0]),u=this.map_point(e,[0,0]),p=Math.max(2,l[0]-u[0]),c=2.5*p,d=n+c/o*.8;h.beginPath(),h.strokeStyle=e.colour,h.lineWidth=p,h.lineCap="round",h.arc(i[0],i[1],o,-a,-d,!1),h.stroke();var f=i[0]+o*Math.cos(-n),m=i[1]+o*Math.sin(-n),g=n-Math.PI/2;h.beginPath(),h.fillStyle=e.colour;var v=g+Math.PI+Math.PI/6,x=g+Math.PI-Math.PI/6;h.moveTo(f,m),h.lineTo(f+c*Math.cos(-v),m+c*Math.sin(-v)),h.lineTo(f+c*Math.cos(-x),m+c*Math.sin(-x)),h.closePath(),h.fill()}},prerender={supersample:2,getScale:function(e){var t=e.width/(e.bounds[1]-e.bounds[0]),r=e.height/(e.bounds[3]-e.bounds[2]);return Math.min(t,r)},getBoundingRadius:function(e){for(var t=0,r=0;r<e.length;r++){var a=Math.sqrt(e[r][0]*e[r][0]+e[r][1]*e[r][1]);a>t&&(t=a)}return t},createCanvas:function(e,t,r){r=r||.5;var a=this.getScale(e),n=a*(e.dpr||1)*this.supersample,s=Math.ceil(2*(t+r)*n)+4,i=document.createElement("canvas");i.width=s,i.height=s;var o=i.getContext("2d");o.translate(s/2,s/2),o.scale(n,n);var h=1/a;return{canvas:i,ctx:o,size:s,scale:n,lineWidth:Math.max(.15,h)}},drawPolygon:function(e,t){e.moveTo(t[0][0],t[0][1]);for(var r=1;r<t.length;r++)e.lineTo(t[r][0],t[r][1]);e.closePath()},drawCircle:function(e,t,r,a,n){e.moveTo(t+a,r),e.arc(t,r,a,0,2*Math.PI,n)},drawArc:function(e,t,r,a,n,s,i){e.arc(t,r,a,n,s,i)},fillAndStroke:function(e,t,r){e.fillStyle=graphics.rgb_to_hex(t[0],t[1],t[2]),e.strokeStyle="#0f0f23",e.lineWidth=r,e.fill(),e.stroke()},externalGear:function(e,t,r){var a=this.getBoundingRadius(t),n=this.createCanvas(e,a);return n.ctx.beginPath(),this.drawPolygon(n.ctx,t),this.fillAndStroke(n.ctx,r,n.lineWidth),{canvas:n.canvas,size:n.size}},internalGear:function(e,t,r){var a;a=t.outerProfile?this.getBoundingRadius(t.outerProfile):t.outerRadius;var n=this.createCanvas(e,a);n.ctx.beginPath(),t.outerProfile?this.drawPolygon(n.ctx,t.outerProfile):this.drawCircle(n.ctx,0,0,t.outerRadius,!1);var s=t.profile;n.ctx.moveTo(s[0][0],s[0][1]);for(var i=s.length-1;i>=0;i--)n.ctx.lineTo(s[i][0],s[i][1]);return n.ctx.closePath(),n.ctx.fillStyle=graphics.rgb_to_hex(r[0],r[1],r[2]),n.ctx.fill("evenodd"),n.ctx.strokeStyle="#0f0f23",n.ctx.lineWidth=n.lineWidth,n.ctx.stroke(),{canvas:n.canvas,size:n.size}},carrier:function(e,t){var r=t.carrierShape,a=t.colors[0],n=this.getBoundingRadius(r.outerGear),s=this.createCanvas(e,n),i=s.ctx,o=r.spokeWidth/2,h=r.spokeCount,l=r.outerRimInner,u=r.innerRingOuter;Math.atan2(o,l),i.beginPath(),this.drawPolygon(i,r.outerGear);for(var p=0;p<h;p++){var c=2*-p*Math.PI/h,d=2*-(p+1)*Math.PI/h,f=-Math.sin(c),m=Math.cos(c),g=-Math.sin(d),v=Math.cos(d),x=Math.atan2(l*Math.sin(c)-o*m,l*Math.cos(c)-o*f),M=Math.atan2(l*Math.sin(d)+o*v,l*Math.cos(d)+o*g),P=Math.atan2(u*Math.sin(d)+o*v,u*Math.cos(d)+o*g),I=Math.atan2(u*Math.sin(d)-o*v,u*Math.cos(d)-o*g);0===p&&i.moveTo(l*Math.cos(x),l*Math.sin(x)),i.arc(0,0,l,x,M,!0),i.lineTo(u*Math.cos(P),u*Math.sin(P)),i.arc(0,0,u,P,I,!0);var y=Math.atan2(l*Math.sin(d)-o*v,l*Math.cos(d)-o*g);i.lineTo(l*Math.cos(y),l*Math.sin(y))}i.closePath(),i.fillStyle=graphics.rgb_to_hex(a[0],a[1],a[2]),i.fill("evenodd"),i.strokeStyle="#0f0f23",i.lineWidth=s.lineWidth,i.stroke(),i.beginPath(),this.drawCircle(i,0,0,u,!1),i.moveTo(r.innerRingInner,0),this.drawCircle(i,0,0,r.innerRingInner,!0),i.fillStyle=graphics.rgb_to_hex(a[0],a[1],a[2]),i.fill("evenodd"),i.strokeStyle="#0f0f23",i.lineWidth=s.lineWidth,i.stroke();var z=puzzle.planetary.orbitRadius,G=1.3*puzzle.module;for(p=0;p<h;p++){var _=2*p*Math.PI/h,S=z*Math.cos(_),b=-z*Math.sin(_);i.beginPath(),this.drawCircle(i,S,b,G,!1),i.moveTo(S+.5,b),this.drawCircle(i,S,b,.5,!0),i.fillStyle=graphics.rgb_to_hex(a[0],a[1],a[2]),i.fill("evenodd"),i.beginPath(),i.arc(S,b,.5,0,2*Math.PI,!1),i.strokeStyle="#0f0f23",i.lineWidth=s.lineWidth,i.stroke();var C=Math.atan2(-b,-S),w=C+Math.PI,O=z,D=G,A=function(e){if(O>0&&O<D+e&&O>Math.abs(D-e)){var t=(O*O+D*D-e*e)/(2*O*D);t=Math.max(-1,Math.min(1,t));var r=Math.acos(t);return{right:C-r,left:C+r}}return null},T=A(r.innerRingInner),R=A(u),k=Math.asin(Math.min(1,o/D)),W=w-k,E=w+k;i.strokeStyle="#0f0f23",i.lineWidth=s.lineWidth,T&&(i.beginPath(),i.arc(S,b,D,T.right,T.left,!1),i.stroke()),R&&(i.beginPath(),i.arc(S,b,D,E,R.right,!1),i.stroke(),i.beginPath(),i.arc(S,b,D,R.left,W,!1),i.stroke())}return{canvas:s.canvas,size:s.size}}};function initPrerenderCache(){anim.ctx&&puzzle.axles&&(prerenderCache.scale=prerender.getScale(anim.ctx),prerenderCache.dpr=anim.ctx.dpr||1,prerenderCache.canvases={},puzzle.axles.forEach(function(e){if(e.isCarrier){var t="carrier_"+e.id;prerenderCache.canvases[t]=prerender.carrier(anim.ctx,e)}else if(e.isInternal){var r=e.gearShapes[0],a=e.colors[0];t="internal_"+e.id,prerenderCache.canvases[t]=prerender.internalGear(anim.ctx,r,a)}else for(var n=0;n<e.gears.length;n++)t=e.gears[n]+"_"+(a=e.colors[n]).join("_"),prerenderCache.canvases[t]||(prerenderCache.canvases[t]=prerender.externalGear(anim.ctx,e.gearShapes[n],a))}),prerenderCache.initialized=!0)}var gears={point_radius:function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},rotate_point:function(e,t,r){var a=[t[0]-e[0],t[1]-e[1]],n=Math.cos(r),s=Math.sin(r);return[n*a[0]+s*a[1]+e[0],-s*a[0]+n*a[1]+e[1]]},involute_point:function(e,t){return[e*(Math.cos(t)+t*Math.sin(t)),-e*(Math.sin(t)-t*Math.cos(t))]},involute_bisect:function(e,t){for(var r=0,a=Math.PI,n=0;n<20;n++){var s=(r+a)/2;this.point_radius(this.involute_point(e,s))<=t?r=s:a=s}return(r+a)/2},involute_curve:function(e,t,r,a){var n=this.involute_bisect(e,r),s=[];t<e&&s.push([t,0]);for(var i=n/(a-1),o=0;o<a;o++)s.push(this.involute_point(e,o*i));return s},generate:function(e,t,r){for(var a=e*r/2,n=a*Math.cos(t),s=a-1.2*e,i=a+1*e,o=Math.PI*a/r,h=this.involute_point(n,this.involute_bisect(n,a)),l=Math.atan2(h[1],h[0]),u=o/a,p=this.involute_curve(n,s,i,20),c=[],d=0;d<p.length;d++){var f=this.rotate_point([0,0],p[d],l-u/2);Math.atan2(f[1],f[0])<Math.PI/r&&f[1]>0&&c.push([p[d][0],p[d][1]])}var m=[];for(d=0;d<r;d++){for(var g=2*d*Math.PI/r+l-u/2,v=2*d*Math.PI/r-l+u/2,x=0;x<c.length;x++)m.push(this.rotate_point([0,0],c[x],g));for(x=c.length-1;x>=0;x--)m.push(this.rotate_point([0,0],[c[x][0],-c[x][1]],v))}return m},translate:function(e,t){return e.map(function(e){return[e[0]+t[0],e[1]+t[1]]})},rotate:function(e,t){var r=Math.cos(t),a=Math.sin(t);return e.map(function(e){return[r*e[0]+a*e[1],-a*e[0]+r*e[1]]})},generateCarrier:function(e,t,r,a,n,s){return{innerRingOuter:r+.5*e,innerRingInner:r-.5*e,outerGear:this.generate(e,t,a),outerRimInner:e*a/2-1.2*e-1*e,spokeCount:n,spokeWidth:s}},generateInternal:function(e,t,r,a,n){n=n||1;for(var s=this,i=this.generate(e,t,r),o=0,h=1/0,l=0;l<i.length;l++)(v=this.point_radius(i[l]))>o&&(o=v),v<h&&(h=v);var u=o-h,p=u*n,c=e*r/2+1*e,d=i.map(function(e){var t=s.point_radius(e),r=Math.atan2(e[1],e[0]),a=o+h-(h+(t-h)/u*p)+(c-o);return[a*Math.cos(r),a*Math.sin(r)]}),f=0;for(l=0;l<d.length;l++)(v=this.point_radius(d[l]))>f&&(f=v);var m=null,g=f+2*e;if(a)for(m=this.generate(e,t,a).map(function(e){var t=s.point_radius(e),r=Math.atan2(e[1],e[0]);return[t*Math.cos(r),t*Math.sin(r)]}),g=0,l=0;l<m.length;l++){var v;(v=this.point_radius(m[l]))>g&&(g=v)}return{profile:d,outerProfile:m,outerRadius:g,innerOuterR:f}}},GearSystem={module:1,pa:20*Math.PI/180,meshDist:function(e,t){return this.module*(e+t)/2},posAt:function(e,t,r){return[e[0]+r*Math.cos(t),e[1]-r*Math.sin(t)]},createPlanetaryGearset:function(e){for(var t=e||{},r=t.prefix||"",a=t.center||[0,0],n=t.sunTeeth||12,s=t.planetTeeth||6,i=t.numPlanets||3,o=t.carrierOuterTeeth||42,h=t.ringOuterTeeth||33,l=t.colors||{},u=GearMath.planetaryRingTeeth(n,s),p=this.meshDist(n,s),c=n/s,d=[],f=r||"planetary",m=[],g=0;g<i;g++)m.push(r+"planet"+g);for(d.push({id:r+"carrier",pos:a,gears:[o],colors:[l.carrier||[180,130,70]],meshParent:null,speedMult:0,meshDir:1,phaseOffset:0,isCarrier:!0,carrierConfig:{innerRadius:p,spokeCount:i,spokeWidth:1},zPriority:3,planetaryId:r,planetaryConstraint:{type:"carrier",setId:f}}),d.push({id:r+"ring",pos:a,gears:[u],outerTeeth:h,colors:[l.ring||[120,90,200]],meshParent:null,speedMult:0,meshDir:1,phaseOffset:0,isInternal:!0,zPriority:-1,planetaryId:r,planetaryConstraint:{type:"ring",setId:f}}),d.push({id:r+"sun",pos:a,gears:[n],colors:[l.sun||[255,200,80]],meshParent:null,speedMult:1,meshDir:1,phaseOffset:0,planetaryId:r,planetaryConstraint:{type:"sun",setId:f}}),g=0;g<i;g++){var v=2*g*Math.PI/i;d.push({id:r+"planet"+g,pos:this.posAt(a,v,p),gears:[s],colors:[l.planet||[100,180,255]],meshParent:r+"sun",meshGearIdx:0,parentGearIdx:0,speedMult:c,meshDir:-1,orbits:r+"sun",orbitSpeed:0,orbitRadius:p,orbitPhase:v,planetaryId:r,planetaryConstraint:{type:"planet",setId:f}})}return{axles:d,config:{id:f,prefix:r,sunTeeth:n,planetTeeth:s,ringTeeth:u,numPlanets:i,gearRatio:c,carrierOuterTeeth:o,ringOuterTeeth:h,orbitRadius:p,center:a,sunId:r+"sun",carrierId:r+"carrier",ringId:r+"ring",planetIds:m}}},updateOrbitingGears:function(e,t){for(var r in e){var a=e[r];if(a.orbits){var n=e[a.orbits],s=null;void 0!==a.planetaryId&&(s=e[a.planetaryId+"carrier"]);var i=s?t*s.speedMult*s.meshDir:t*(a.orbitSpeed||0),o=s&&s.phaseOffset||0,h=i+(a.orbitPhase||0)+o;a.pos=[n.pos[0]+a.orbitRadius*Math.cos(h),n.pos[1]-a.orbitRadius*Math.sin(h)];var l=-h,u=n.gears[a.parentGearIdx||0],p=a.gears[a.meshGearIdx||0];a.phaseOffset=GearMath.calculateChildPhase(n.phaseOffset||0,l,u,p)}}},generateShapes:function(e){var t={},r={},a=this;e.forEach(function(e){if(e.isCarrier){var n=e.carrierConfig;e.carrierShape=gears.generateCarrier(a.module,a.pa,n.innerRadius,e.gears[0],n.spokeCount,n.spokeWidth)}else if(e.isInternal){var s=e.outerTeeth||null,i=e.gears[0]+"_"+(s||"none");r[i]||(r[i]=gears.generateInternal(a.module,a.pa,e.gears[0],s)),e.gearShapes=[r[i]]}else e.gearShapes=e.gears.map(function(e){return t[e]||(t[e]=gears.generate(a.module,a.pa,e)),t[e]})})}},puzzle={module:1,pa:20*Math.PI/180,baseSpeed:.5,axles:[],planetarySets:[],outputGears:[]},adjustParams={driverAngle:.08,driverRadius:45,yellowAngleOffset:-44,yellowSpacerBend:-6,orangeAngleOffset:-37,redAngleOffset:-4,blueAngleOffset:-40,blueBend:84,sunInputAngle:6,sunBendAngle:54,greenInter1Angle:0,greenOutputAngle:-49,speed:.5};function setupPuzzle(){GearSystem.module=puzzle.module,GearSystem.pa=puzzle.pa;var e=[],t=Math.PI/2,r=Math.PI/10,a=17*Math.PI/10,n=13*Math.PI/10,s=9*Math.PI/10,i=Math.PI*adjustParams.driverAngle,o=adjustParams.driverRadius,h=GearSystem.posAt([0,0],i,o),l=GearSystem.meshDist(6,36),u=GearSystem.posAt(h,i,l),p=GearSystem.meshDist(36,12),c=GearSystem.meshDist(12,21),d=GearSystem.meshDist(42,12),f=adjustParams.sunInputAngle*Math.PI/180,m=Math.atan2(-h[1],-h[0])+f,g=GearSystem.posAt(h,m,p),v=GearSystem.posAt(g,m,c),x=m+adjustParams.sunBendAngle*Math.PI/180,M=GearSystem.posAt(v,x,d),P=GearSystem.createPlanetaryGearset({prefix:"",center:M,sunTeeth:12,planetTeeth:6,numPlanets:3,carrierOuterTeeth:36,ringOuterTeeth:42});e=e.concat(P.axles),puzzle.planetarySets.push(P.config),puzzle.planetary=P.config;var I=M;e.push({id:"driver",pos:u,gears:[6],colors:[[255,100,100]],meshParent:null,speedMult:1,meshDir:1,phaseOffset:0,isDriver:!0}),e.push({id:"hub",pos:h,gears:[36],colors:[[200,180,160]],meshParent:"driver",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0}),e.push({id:"sunIdler",pos:g,gears:[12],colors:[[255,180,60]],meshParent:"hub",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0}),e.push({id:"sunInput1",pos:v,gears:[21,42],colors:[[255,200,100],[230,180,80]],meshParent:"sunIdler",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:-1});var y=e.find(function(e){return"sun"===e.id});y.meshParent="sunInput1",y.meshGearIdx=0,y.parentGearIdx=1,y.meshDir=-1;var z=t+adjustParams.redAngleOffset*Math.PI/180,G=GearSystem.meshDist(36,30),_=GearSystem.posAt(h,z,G),S=GearSystem.meshDist(6,24),b=GearSystem.posAt(_,z,S);e.push({id:"red_inter1",pos:_,gears:[30,6],colors:[[220,60,60],[180,40,40]],meshParent:"hub",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:1}),e.push({id:"red_output",pos:b,gears:[24],colors:[[255,80,80]],meshParent:"red_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:20,zPriority:2});var C=a+adjustParams.yellowAngleOffset*Math.PI/180,w=GearSystem.meshDist(36,36),O=GearSystem.posAt(h,C,w),D=C+adjustParams.yellowSpacerBend*Math.PI/180,A=GearSystem.meshDist(6,24),T=GearSystem.posAt(O,D,A),R=GearSystem.meshDist(24,18),k=GearSystem.posAt(T,D,R);e.push({id:"yellow_inter1",pos:O,gears:[36,6],colors:[[220,200,60],[180,160,40]],meshParent:"hub",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:2}),e.push({id:"yellow_spacer",pos:T,gears:[24],colors:[[200,180,50]],meshParent:"yellow_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,zPriority:2}),e.push({id:"yellow_output",pos:k,gears:[18],colors:[[255,220,60]],meshParent:"yellow_spacer",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:18,zPriority:3});var W,E,j,B,F,L,q,H,V,J,K,N,Q,U,X,Y=(W=O,j=GearSystem.meshDist(36,14),B=GearSystem.meshDist(36,36),F=(E=I)[0]-W[0],L=E[1]-W[1],H=(j*j-B*B+(q=Math.sqrt(F*F+L*L))*q)/(2*q),V=Math.sqrt(Math.max(0,j*j-H*H)),(U=[(J=W[0]+H*F/q)+V*(N=-L/q),(K=W[1]+H*L/q)+V*(Q=F/q)])[1]>(X=[J-V*N,K-V*Q])[1]?U:X);e.push({id:"carrierInput1",pos:Y,gears:[14,36],colors:[[180,150,100],[160,130,80]],meshParent:"yellow_inter1",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,zPriority:1});var Z=e.find(function(e){return"carrier"===e.id});Z.meshParent="carrierInput1",Z.meshGearIdx=0,Z.parentGearIdx=1,Z.meshDir=-1;var $=s+adjustParams.blueAngleOffset*Math.PI/180,ee=GearSystem.meshDist(42,36),te=GearSystem.posAt(v,$,ee),re=$+adjustParams.blueBend*Math.PI/180,ae=GearSystem.meshDist(6,38),ne=GearSystem.posAt(te,re,ae);e.push({id:"blue_inter1",pos:te,gears:[36,6],colors:[[60,100,200],[40,80,180]],meshParent:"sunInput1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,zPriority:1}),e.push({id:"blue_output",pos:ne,gears:[38],colors:[[80,140,255]],meshParent:"blue_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:19,zPriority:2});var se=n+adjustParams.greenInter1Angle*Math.PI/180,ie=se+adjustParams.greenOutputAngle*Math.PI/180,oe=GearSystem.meshDist(42,21),he=GearSystem.posAt(I,se,oe),le=GearSystem.meshDist(6,24),ue=GearSystem.posAt(he,ie,le);e.push({id:"green_inter1",pos:he,gears:[21,6],colors:[[60,180,80],[40,160,60]],meshParent:"ring",meshGearIdx:0,parentGearIdx:0,meshDir:-1,phaseOffset:0,meshWithOuter:!0,zPriority:1}),e.push({id:"green_output",pos:ue,gears:[24],colors:[[80,220,100]],meshParent:"green_inter1",meshGearIdx:0,parentGearIdx:1,meshDir:-1,phaseOffset:0,isLeaf:!0,ratio:14,zPriority:2});var pe=24*GearSystem.module/2,ce=60+25*GearSystem.module,de=Math.round(2*ce/GearSystem.module);de%2!=0&&de++;var fe=(ce=GearSystem.module*de/2)-pe,me=Math.sqrt(ue[0]*ue[0]+ue[1]*ue[1]),ge=-ue[0]/me,ve=-ue[1]/me,xe=[ue[0]+fe*ge,ue[1]+fe*ve];e.push({id:"outerRing",pos:xe,gears:[de],colors:[[80,80,120]],meshParent:"green_output",meshGearIdx:0,parentGearIdx:0,meshDir:1,phaseOffset:0,isInternal:!0,isOuterRing:!0,zPriority:-5}),puzzle.outerRingTeeth=de;var Me=r+adjustParams.orangeAngleOffset*Math.PI/180,Pe=ce-36*GearSystem.module/2,Ie=GearSystem.posAt(xe,Me,Pe);e.push({id:"orange_output",pos:Ie,gears:[36],colors:[[255,140,40]],meshParent:"outerRing",meshGearIdx:0,parentGearIdx:0,meshDir:1,phaseOffset:0,meshWithInternal:!0,isLeaf:!0,ratio:21,zPriority:2}),puzzle.outputGears=["red_output","orange_output","yellow_output","green_output","blue_output"],puzzle.axles=e,calculateSpeeds(),calculatePhaseOffsets(),GearSystem.generateShapes(puzzle.axles)}function getParents(e){if(e.planetaryConstraint){var t=e.planetaryConstraint.type;if("ring"===t||"planet"===t)return[]}return e.meshParent?[e.meshParent]:[]}function isInternalMesh(e,t){return e.isInternal&&!t.meshWithOuter||t.meshWithInternal||t.isInternal}function getEffectiveTeeth(e,t){return t.meshWithOuter&&e.outerTeeth?e.outerTeeth:e.gears[t.parentGearIdx||0]}function checkPlanetaryConstraint(e,t,r,a,n,s){if(e.planetaryConstraint){var i=e.planetaryConstraint.setId,o=puzzle.planetarySets.find(function(e){return e.id===i});if(o){var h=t[o.sunId],l=t[o.carrierId];if(r[o.sunId]&&r[o.carrierId]&&!r[o.ringId]){var u=t[o.ringId],p=o.sunTeeth,c=o.ringTeeth,d=o.planetTeeth;if("speed"===s){var f=h.speedMult*h.meshDir,m=l.speedMult*l.meshDir,g=GearMath.planetaryRingSpeed(f,m,p,c);u.speedMult=Math.abs(g),u.meshDir=g>=0?1:-1}else if("phase"===s){var v=l.phaseOffset||0,x=-v,M=GearMath.calculateChildPhase(h.phaseOffset||0,x,p,d),P=v;u.phaseOffset=GearMath.calculateRingPhaseFromPlanet(M,P,d,c)}a.push(u.id),o.planetIds.forEach(function(e){if(!r[e]){var n=t[e];"speed"===s&&(n.speedMult=h.speedMult*(p/d),n.meshDir=-h.meshDir,n.orbitSpeed=l.speedMult,n.orbitDir=l.meshDir),r[e]=!0,a.push(e)}})}}}}function bfsTraverse(e,t,r){var a={};e.forEach(function(e){a[e.id]=e});var n={},s={},i=[];for(e.forEach(function(e){var t=getParents(e);if(s[e.id]=t.length,e.planetaryConstraint){var r=e.planetaryConstraint.type;if("ring"===r||"planet"===r)return}0===t.length&&i.push(e.id)});i.length>0;){var o=i.shift();if(!n[o]){var h=a[o];t(h,a,n),n[o]=!0,e.forEach(function(e){getParents(e).includes(o)&&(s[e.id]--,0!==s[e.id]||n[e.id]||i.push(e.id))}),checkPlanetaryConstraint(h,a,n,i,t,r)}}return a}function calculateSpeeds(){var e=bfsTraverse(puzzle.axles,function(e,t,r){if(e.isDriver)return e.speedMult=1,void(e.meshDir=1);if(e.planetaryConstraint){var a=e.planetaryConstraint.type;if("ring"===a||"planet"===a)return}if(e.meshParent){var n=t[e.meshParent];if(n){var s=getEffectiveTeeth(n,e),i=e.gears[e.meshGearIdx||0];e.speedMult=n.speedMult*(s/i),e.meshDir=isInternalMesh(n,e)?n.meshDir:-n.meshDir}}},"speed");puzzle.axleMap=e}function calculatePhaseOffsets(){bfsTraverse(puzzle.axles,function(e,t,r){if(e.isDriver)e.phaseOffset=0;else{if(e.planetaryConstraint){var a=e.planetaryConstraint.type;if("ring"===a)return;if("planet"===a)return}if(e.meshParent){var n=t[e.meshParent];if(n){var s=getEffectiveTeeth(n,e),i=e.gears[e.meshGearIdx||0],o=e.pos[0]-n.pos[0],h=e.pos[1]-n.pos[1],l=Math.atan2(h,o);isInternalMesh(n,e)?e.phaseOffset=GearMath.calculateInternalMeshPhase(n.phaseOffset||0,l,s,i):e.phaseOffset=GearMath.calculateChildPhase(n.phaseOffset||0,l,s,i)}}}},"phase")}var anim={ctx:null,baseAngle:0,lastTime:0},prerenderCache={canvases:{},scale:1,dpr:1,initialized:!1};function resizeCanvas(){var e=document.getElementById("gear_canvas"),t=window.devicePixelRatio||1,r=window.innerWidth,a=window.innerHeight;e.style.width=r+"px",e.style.height=a+"px",e.width=r*t,e.height=a*t;var n=1/0,s=-1/0,i=1/0,o=-1/0;puzzle.axles.forEach(function(e){var t=Math.max.apply(null,e.gears)*puzzle.module/2+1.5*puzzle.module;n=Math.min(n,e.pos[0]-t),s=Math.max(s,e.pos[0]+t),i=Math.min(i,e.pos[1]-t),o=Math.max(o,e.pos[1]+t)}),anim.ctx=graphics.init(e,[n-5,s+5,i-5,o+5]),anim.ctx.context.scale(t,t),anim.ctx.dpr=t,anim.ctx.width=r,anim.ctx.height=a,prerenderCache.initialized=!1,prerenderCache.canvases={},puzzle.axles&&puzzle.axles.length>0&&initPrerenderCache()}function init(){setupPuzzle(),resizeCanvas(),initPrerenderCache();var e=window.innerWidth,t=window.innerHeight;window.addEventListener("resize",function(){var r=Math.abs(window.innerWidth-e),a=Math.abs(window.innerHeight-t);(r>100||a>100)&&(e=window.innerWidth,t=window.innerHeight,resizeCanvas())}),document.getElementById("speed").addEventListener("input",function(){adjustParams.speed=parseInt(this.value)/100,document.getElementById("speedVal").textContent=adjustParams.speed.toFixed(2)}),anim.lastTime=performance.now(),requestAnimationFrame(drawFrame)}function drawFrame(e){var t=(e-anim.lastTime)/1e3;anim.lastTime=e,anim.baseAngle-=adjustParams.speed*t;var r=puzzle.axleMap;r||(r={},puzzle.axles.forEach(function(e){r[e.id]=e}),puzzle.axleMap=r),GearSystem.updateOrbitingGears(r,anim.baseAngle),graphics.clear(anim.ctx),puzzle.axles.slice().sort(function(e,t){var r=e.zPriority||0,a=t.zPriority||0;return r!==a?r-a:Math.max.apply(null,t.gears)-Math.max.apply(null,e.gears)}).forEach(function(e){var t=anim.baseAngle*e.speedMult*e.meshDir+(e.phaseOffset||0);function r(e,t,r){var a=anim.ctx.context,n=anim.ctx.dpr||1,s=e.size/(n*prerender.supersample),i=s/2;a.save(),a.translate(t[0],t[1]),a.rotate(-r),a.drawImage(e.canvas,-i,-i,s,s),a.restore()}if(e.isCarrier){var a="carrier_"+e.id;(o=prerenderCache.canvases[a])&&prerenderCache.initialized&&r(o,graphics.map_point(anim.ctx,e.pos),t)}else if(e.isInternal)a="internal_"+e.id,(o=prerenderCache.canvases[a])&&prerenderCache.initialized&&r(o,graphics.map_point(anim.ctx,e.pos),t);else{for(var n=[],s=0;s<e.gears.length;s++)n.push(s);n.sort(function(t,r){return e.gears[r]-e.gears[t]});for(var i=0;i<n.length;i++){var o,h=n[i],l=e.gears[h];if(a=l+"_"+e.colors[h].join("_"),(o=prerenderCache.canvases[a])&&prerenderCache.initialized)r(o,graphics.map_point(anim.ctx,e.pos),t);else{var u=gears.rotate(e.gearShapes[h],t);u=gears.translate(u,e.pos);var p=e.colors[h];graphics.color(anim.ctx,p[0],p[1],p[2]),graphics.polyline(anim.ctx,u,!0)}if(l>12){var c=puzzle.module*l/2,d=.65*c,f=e.pos[0]+d*Math.cos(t),m=e.pos[1]-d*Math.sin(t);graphics.color(anim.ctx,255,255,255),graphics.textRotated(anim.ctx,[f,m],l.toString(),.2*c,t-Math.PI/2)}}}}),puzzle.axles.forEach(function(e){e.isOuterRing||(graphics.color(anim.ctx,30,30,50),graphics.fillCircle(anim.ctx,e.pos,.8))}),puzzle.axles.forEach(function(e){var t=null,r=0;if(e.isDriver?(t="1",r=2):e.isLeaf&&(t="?",r=4),t){var a=e.pos[0],n=e.pos[1],s=anim.baseAngle*e.speedMult*e.meshDir+(e.phaseOffset||0);graphics.color(anim.ctx,255,255,255),graphics.fillCircle(anim.ctx,[a,n],r),graphics.color(anim.ctx,30,30,50),graphics.textRotated(anim.ctx,[a,n],t,1.2*r,s)}});var a=r.outerRing;if(a){var n=puzzle.module*puzzle.outerRingTeeth/2+8,s=Math.PI/4+.25,i=Math.PI/4-.15;graphics.color(anim.ctx,200,200,200),graphics.arcArrowCW(anim.ctx,a.pos,n,s,i,.8)}requestAnimationFrame(drawFrame)}window.onload=init;</script></body></html>